<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Incident Diary Pro ‚Äî DFES Grid Report</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,#1a1a1a,#2d2d2d);color:#fff;min-height:100%
    }
    .container{max-width:100%;min-height:100vh;display:flex;flex-direction:column}
    .header{background:linear-gradient(90deg,#ff4444,#cc3333);padding:1rem;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.3)}
    .header h1{font-size:1.5rem;font-weight:700}
    .incident-info{margin-top:.25rem;font-size:.9rem;opacity:.9}

    .tab-nav{display:flex;background:#333;border-bottom:2px solid #ff4444}
    .tab-btn{flex:1;padding:1rem;background:none;border:none;color:#ccc;font-weight:600;cursor:pointer;transition:.2s;position:relative;font-size:.9rem}
    .tab-btn.active{color:#ff4444;background:#2a2a2a}
    .tab-btn.active::after{content:"";position:absolute;bottom:-2px;left:0;right:0;height:2px;background:#ff4444}
    .tab-btn:disabled{opacity:.5;cursor:not-allowed}
    .tab-content{display:none;padding:1rem;flex:1;overflow-y:auto}
    .tab-content.active{display:block}

    .btn{background:linear-gradient(90deg,#ff4444,#cc3333);color:#fff;border:none;border-radius:8px;padding:.75rem 1.25rem;font-weight:700;cursor:pointer;transition:.2s;width:100%;margin-top:1rem;font-size:1rem}
    .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,68,68,.25)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-secondary{background:#444}
    .btn-danger{background:linear-gradient(90deg,#dc2626,#b91c1c)}
    .btn-xs{padding:.4rem .6rem;font-size:.85rem;border-radius:6px;width:auto}

    .setup-form{max-width:560px;margin:0 auto}
    .form-group{margin-bottom:1rem}
    .form-group label{display:block;margin-bottom:.5rem;color:#ff6666;font-weight:700}
    .form-group input[type="text"],.form-group input[type="number"]{width:100%;padding:.75rem;border:2px solid #444;border-radius:8px;background:#2a2a2a;color:#fff}
    .form-group input:focus{outline:none;border-color:#ff4444;box-shadow:0 0 0 3px rgba(255,68,68,.2)}
    .incident-row{display:grid;grid-template-columns:1fr auto;gap:.5rem;align-items:center}
    .no-incident-checkbox{display:inline-flex;align-items:center;gap:.35rem;white-space:nowrap;color:#ccc}

    /* Notes UI */
    .notes-controls{max-width:1100px;margin:0 auto}
    .note-label{display:block;font-weight:700;color:#ff6666;margin:.5rem 0 .4rem}
    .note-input{width:100%;min-height:110px;padding:.75rem;border:2px solid #444;border-radius:8px;background:#2a2a2a;color:#fff;resize:vertical}
    .note-hint{color:#bbb;font-size:.9rem;margin-top:.35rem}
    .input-row{display:flex;gap:.5rem;margin-top:.6rem}
    .voice-btn{background:#444;color:#fff;border:none;border-radius:8px;padding:.75rem 1.25rem;font-weight:700;flex:1 1 0}
    .voice-btn.recording{background:#ff4444;animation:pulse 1s infinite}
    #addNoteBtn{flex:1 1 0}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}

    .tofrom-panel{display:grid;grid-template-columns:1fr;gap:.5rem;margin-top:.5rem;background:#252525;border:1px solid #444;border-radius:8px;padding:.75rem}
    .tofrom-row{display:grid;grid-template-columns:auto 1fr auto 1fr;gap:.5rem;align-items:center}
    .tofrom-row label{color:#ddd;font-size:.9rem}
    .tofrom-row input[type="text"]{width:100%;padding:.5rem;border:1px solid #444;border-radius:6px;background:#1f1f1f;color:#fff}
    .tofrom-checks{display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
    .tofrom-checks label{display:flex;align-items:center;gap:.35rem;color:#bbb}

    .status-message{padding:.75rem;border-radius:6px;margin:.75rem 0;text-align:center;font-weight:700}

    /* Report controls */
    .report-controls{max-width:1300px;margin:0 auto 8px;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;justify-content:center}
    .report-search{position:relative;width:min(100%,800px)}
    .report-search input{width:100%;padding:.65rem 2.25rem .65rem .75rem;border:1px solid #888;border-radius:6px;background:#fff;color:#000}
    .report-search button{position:absolute;right:.25rem;top:50%;transform:translateY(-50%);background:#eee;border:1px solid #bbb;padding:.3rem .6rem;border-radius:4px;cursor:pointer}

    .pager{display:none;align-items:center;justify-content:center;gap:.75rem;margin:0 auto 8px}
    .pager button{background:#eee;border:1px solid #bbb;border-radius:8px;padding:.4rem .8rem;color:#111;cursor:pointer;font-weight:700}
    .pager .info{color:#ddd}

    .report-preview{background:#fff;color:#000;border-radius:8px;padding:12px;border:1px solid #444;max-width:1300px;margin:0 auto 1rem;overflow:auto}

    :root{
      --grid-font:"Arial",sans-serif;
      --grid-title-size:18px;
      --grid-label-size:12px;
      --grid-cell-size:13px;
      --grid-border:#666;
      --grid-page-number:#d12a2a;
      --col-datetime:140px;
      --col-from:130px;
      --col-to:130px;
      --col-note:auto;
    }

    /* Report sheet */
    .dfes-sheet{font-family:var(--grid-font);background:#fff;color:#000;border:1px solid var(--grid-border);padding:12px;position:relative}
    .dfes-title{text-align:center;font-weight:800;font-size:var(--grid-title-size)}
    .dfes-page-row{display:grid;grid-template-columns:1fr auto;align-items:center;border-bottom:1px solid var(--grid-border);padding-bottom:6px;margin:6px 0}
    .dfes-page{text-align:right;font-size:var(--grid-label-size)}
    .dfes-page .num{color:var(--grid-page-number);font-weight:800}

    .meta-table{width:100%;border-collapse:collapse;margin:8px 0 10px 0;font-family:var(--grid-font);font-size:var(--grid-label-size)}
    .meta-table colgroup col{width:16.666%}
    .meta-table th,.meta-table td{border:1px solid var(--grid-border);padding:4px 6px;vertical-align:middle;background:#fff;min-height:28px;line-height:1.2;white-space:nowrap}
    .meta-label{background:#f6f6f6;font-weight:700;color:#000}
    .meta-value{font-weight:400;color:#000}

    .dfes-grid{margin-top:6px;border:1px solid var(--grid-border);border-collapse:collapse;width:100%;table-layout:fixed}
    .dfes-grid th,.dfes-grid td{border:1px solid var(--grid-border);padding:4px 6px;font-size:var(--grid-cell-size);vertical-align:top}
    .dfes-grid thead th{background:#f6f6f6;font-weight:700}
    .col-datetime{width:var(--col-datetime)}
    .col-from{width:var(--col-from)}
    .col-to{width:var(--col-to)}
    .badge{display:inline-block;padding:.1rem .35rem;border-radius:4px;background:#fde68a;color:#7c2d12;font-size:10px;font-weight:700;margin-left:6px}

    .app-footer{color:#bbb;text-align:center;padding:10px 12px;font-size:.9rem;border-top:1px solid rgba(255,255,255,.1)}

    @media print{
      body{background:#fff;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact}
      .tab-nav,.btn,.notes-controls,.status-message,.report-controls,.app-footer,#notesMicAssist,.pager{display:none !important}
      .report-preview{border:none;padding:0;margin:0;max-width:none}
      @page{size:A4 landscape;margin:12mm}
      /* No footers at all */
    }

    @media (max-width:767px){
      .tab-btn{padding:1.1rem .5rem;font-size:.85rem}
      .btn,.voice-btn{padding:1rem;font-size:1.05rem}
      .tofrom-row{grid-template-columns:1fr}
      .input-row{flex-direction:column}
      .input-row .voice-btn,#addNoteBtn{width:100%}
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Incident Diary Pro</h1>
      <div id="incidentInfo" class="incident-info">Incident Logger - Set up your incident details</div>
    </header>

    <nav class="tab-nav" role="tablist">
      <button id="setup-btn" class="tab-btn active" role="tab" aria-selected="true" aria-controls="setup-tab">üìã Setup</button>
      <button id="notes-btn" class="tab-btn" role="tab" aria-selected="false" aria-controls="notes-tab" disabled>üìù Notes</button>
      <button id="report-btn" class="tab-btn" role="tab" aria-selected="false" aria-controls="report-tab" disabled>üìÑ Report</button>
    </nav>

    <!-- Setup -->
    <main id="setup-tab" class="tab-content active" role="tabpanel" aria-labelledby="setup-btn">
      <form id="setupForm" class="setup-form">
        <div class="form-group">
          <label for="authorName">Author Name *</label>
          <input id="authorName" name="authorName" type="text" required placeholder="Enter your full name" autocomplete="name"/>
        </div>
        <div class="form-group">
          <label for="incidentName">Incident Name (optional)</label>
          <input id="incidentName" name="incidentName" type="text" placeholder="Bunbury Bushfire"/>
        </div>
        <div class="form-group">
          <label for="incidentNumber">Incident Number</label>
          <div class="incident-row">
            <input id="incidentNumber" name="incidentNumber" type="text" placeholder="e.g., 621223" autocomplete="off"/>
            <label class="no-incident-checkbox"><input type="checkbox" id="noIncidentCheckbox"/> No Incident Number</label>
          </div>
        </div>
        <div class="form-group">
          <label for="dfesId">DFES ID Number (Service No) *</label>
          <input id="dfesId" name="dfesId" type="text" required placeholder="e.g., 123456" autocomplete="off"/>
        </div>
        <div class="form-group">
          <label for="userRole">Your Role *</label>
          <input id="userRole" name="userRole" type="text" required placeholder="e.g., RDC, IC, OO, PO, PIO, LO"/>
        </div>
        <div class="form-group">
          <label for="diaryPageStart">Diary Page Number (optional)</label>
          <input id="diaryPageStart" name="diaryPageStart" type="number" min="0" step="1" placeholder="e.g., 100 for PAGE: 000100"/>
        </div>
        <button id="submitBtn" type="submit" class="btn">Start Logging Notes</button>
      </form>
      <div id="setupStatus" class="status-message" style="display:none;"></div>
    </main>

    <!-- Notes -->
    <main id="notes-tab" class="tab-content" role="tabpanel" aria-labelledby="notes-btn">
      <div class="notes-controls">
        <!-- Moved To/From/Follow Up above textarea -->
        <div class="tofrom-panel" aria-label="To/From options">
          <div class="tofrom-row">
            <label for="fromName">From</label>
            <input id="fromName" type="text" placeholder="Role or name (optional)"/>
            <label for="toName">To</label>
            <input id="toName" type="text" placeholder="Role or name (optional)"/>
          </div>
          <div class="tofrom-checks">
            <label><input type="checkbox" id="includeFrom" checked/> Include From</label>
            <label><input type="checkbox" id="includeTo" checked/> Include To</label>
            <label><input type="checkbox" id="followUpCheckbox"/> Requires Follow Up</label>
          </div>
        </div>

        <label class="note-label" for="noteInput">Enter Notes Below</label>
        <textarea id="noteInput" class="note-input" placeholder="Enter your note here..."></textarea>
        <div class="note-hint">Note will be time stamped when added.</div>

        <div class="input-row">
          <button id="voiceBtn" class="voice-btn" type="button">üé§ Voice</button>
          <button id="addNoteBtn" class="btn" type="button">Add Note</button>
        </div>

        <div id="voiceStatus" class="status-message" style="display:none;"></div>
      </div>

      <div id="notesList" class="notes-list" role="region" aria-label="Notes list">
        <div class="status-message status-info">No notes yet. Add your first note above!</div>
      </div>

      <!-- Mic assist -->
      <div id="notesMicAssist" style="max-width:1100px;margin:12px auto 0;display:flex;flex-direction:column;align-items:center;text-align:center;">
        <button id="enableMicBtn" class="btn btn-secondary btn-xs" type="button" style="min-width:210px;">Turn on Microphone</button>
        <div style="font-size:.9rem;color:#bbb;margin-top:.4rem;">Best Browser ‚Äî Chrome</div>
        <div id="micAssistStatus" class="status-message" style="display:none;margin-top:.5rem;width:100%;max-width:480px;"></div>
      </div>
    </main>

    <!-- Report -->
    <main id="report-tab" class="tab-content" role="tabpanel" aria-labelledby="report-btn">
      <div class="report-controls" style="flex-direction:column; gap:8px;">
        <div class="pager" id="pager">
          <button id="prevPageBtn" type="button">‚¨Ö Prev</button>
          <div class="info" id="pagerInfo">Page 1 of 1</div>
          <button id="nextPageBtn" type="button">Next ‚û°</button>
        </div>
        <div class="report-search">
          <input id="reportSearchInput" type="text" placeholder="Search report rows..."/>
          <button id="reportSearchClear" type="button">Clear</button>
        </div>
      </div>

      <div id="reportPreview" class="report-preview">
        <div class="status-message status-info">Complete setup and add notes to generate a report.</div>
      </div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;">
        <button id="downloadPdfBtn" class="btn btn-secondary" disabled>üñ®Ô∏è Print to PDF</button>
        <button id="emailBtn" class="btn btn-secondary" disabled>üìß Email Report</button>
        <button id="clearDataBtn" class="btn btn-danger" type="button">üóëÔ∏è Clear All Data</button>
      </div>
    </main>

    <footer class="app-footer">Created by Ben Davies</footer>
  </div>

  <script>
    // App state
    var appState = {
      author:"",incidentName:"",incidentNumber:"",noIncident:false,dfesId:"",role:"",
      diaryPageStart:null,notes:[],currentTab:"setup",isRecording:false,recognition:null,voiceTranscript:"",
      reportPages:[],currentReportPageIndex:0
    };

    // Helpers
    function $(id){return document.getElementById(id)}
    function show(el){el.style.display="flex"}
    function hide(el){el.style.display="none"}
    function showStatus(id,msg,type){var el=$(id);if(!el)return;el.textContent=msg;el.className="status-message status-"+(type||"info");el.style.display="block"}
    function hideStatus(id){var el=$(id);if(el)el.style.display="none"}
    function formatTimestamp(ts){var d=new Date(ts);var dd=String(d.getDate()).padStart(2,"0");var mm=String(d.getMonth()+1).padStart(2,"0");var yy=String(d.getFullYear()).slice(-2);var hh=String(d.getHours()).padStart(2,"0");var mi=String(d.getMinutes()).padStart(2,"0");return dd+"/"+mm+"/"+yy+" "+hh+":"+mi}
    function escapeHtml(t){var div=document.createElement("div");div.textContent=t||"";return div.innerHTML}
    function pad6(n){var num=Math.max(0,parseInt(n,10)||0);return String(num).padStart(6,"0")}

    document.addEventListener("DOMContentLoaded",function(){setupEvents();setupSpeechRecognition();});

    function setupEvents(){
      $("setup-btn").addEventListener("click",function(){switchTab("setup")});
      $("notes-btn").addEventListener("click",function(){switchTab("notes")});
      $("report-btn").addEventListener("click",function(){switchTab("report")});

      $("setupForm").addEventListener("submit",onSetupSubmit);
      $("noIncidentCheckbox").addEventListener("change",function(e){
        appState.noIncident=e.target.checked;var inc=$("incidentNumber");
        inc.disabled=appState.noIncident;if(appState.noIncident)inc.value="";
      });

      $("addNoteBtn").addEventListener("click",addNote);
      $("noteInput").addEventListener("keydown",function(e){
        if(e.key==="Enter"&&(e.ctrlKey||e.metaKey)){e.preventDefault();addNote();}
      });

      $("reportSearchInput").addEventListener("input",function(){
        $("reportSearchClear").style.display=$("reportSearchInput").value?"inline-block":"none";
        generateReport();
      });
      $("reportSearchClear").addEventListener("click",function(){
        $("reportSearchInput").value=""; this.style.display="none"; generateReport();
      });

      $("downloadPdfBtn").addEventListener("click",printToPdf);
      $("emailBtn").addEventListener("click",emailReport);
      $("clearDataBtn").addEventListener("click",clearAllData);

      $("notesList").addEventListener("click",notesListClick);

      $("prevPageBtn").addEventListener("click",function(){ changeReportPage(-1); });
      $("nextPageBtn").addEventListener("click",function(){ changeReportPage(1); });

      var enableBtn=$("enableMicBtn"); if(enableBtn) enableBtn.addEventListener("click",requestMicrophoneAccess);
    }

    function onSetupSubmit(e){
      e.preventDefault();
      appState.author=$("authorName").value.trim();
      appState.incidentName=$("incidentName").value.trim();
      appState.incidentNumber=$("incidentNumber").value.trim();
      appState.noIncident=$("noIncidentCheckbox").checked;
      appState.dfesId=$("dfesId").value.trim();
      appState.role=$("userRole").value.trim();
      var pv=$("diaryPageStart").value.trim();
      appState.diaryPageStart=pv===""?null:Math.max(0,parseInt(pv,10)||0);

      if(!(appState.author&&appState.dfesId&&appState.role&&(appState.noIncident||appState.incidentNumber))){
        showStatus("setupStatus","Please fill all required fields.","error");return;
      }
      updateIncidentInfo();
      $("notes-btn").disabled=false;
      $("report-btn").disabled=false;
      switchTab("notes");
      $("noteInput").focus();
      hideStatus("setupStatus");
    }

    function updateIncidentInfo(){
      var incText=appState.noIncident?"No Incident Number":appState.incidentNumber;
      var incName=appState.incidentName?(" | "+appState.incidentName):"";
      var extra=appState.diaryPageStart!=null?(" | Page Start: "+pad6(appState.diaryPageStart)):"";
      $("incidentInfo").textContent=incText+incName+" | DFES ID: "+appState.dfesId+" | "+appState.author+" ("+appState.role+")"+extra;
    }

    function switchTab(tab){
      appState.currentTab=tab;
      document.querySelectorAll(".tab-btn").forEach(function(b){
        var isActive=b.id===(tab+"-btn"); b.classList.toggle("active",isActive); b.setAttribute("aria-selected",isActive);
      });
      document.querySelectorAll(".tab-content").forEach(function(c){c.classList.remove("active")});
      $(tab+"-tab").classList.add("active");
      if(tab==="report") generateReport();
      if(tab==="notes") renderNotes();
    }

    // Notes
    function addNote(){
      var text=$("noteInput").value.trim();
      var toName=$("toName").value.trim();
      var fromName=$("fromName").value.trim();
      var includeTo=$("includeTo").checked && toName.length>0;
      var includeFrom=$("includeFrom").checked && fromName.length>0;
      var followUpRequired=$("followUpCheckbox").checked;
      if(!text) return;

      var note={
        id: Date.now()+Math.floor(Math.random()*1000),
        timestamp: new Date(),
        text: text,
        to: toName, from: fromName,
        includeTo: includeTo, includeFrom: includeFrom,
        followUp: followUpRequired,
        followUps: [] // [{ts, text}]
      };
      appState.notes.unshift(note);
      $("noteInput").value="";
      $("followUpCheckbox").checked=false; // reset for next note
      renderNotes();
      if(appState.currentTab==="report") generateReport();
    }

    function addFollowUp(noteId){
      var input = document.getElementById("fu-input-"+noteId);
      if(!input) return;
      var text = input.value.trim();
      if(!text) return;
      var note = appState.notes.find(function(n){return n.id===noteId});
      if(!note) return;
      note.followUps.push({ ts:new Date(), text:text });
      note.followUp = true;
      input.value = "";
      renderNotes();
      if(appState.currentTab==="report") generateReport();
    }

    function deleteNote(id){
      appState.notes=appState.notes.filter(function(n){return n.id!==id});
      renderNotes();
      if(appState.currentTab==="report") generateReport();
    }
    function editNoteInline(id){
      var textEl=$("note-text-"+id);
      var n=appState.notes.find(function(x){return x.id===id});
      if(!n||!textEl) return;
      var original=n.text;
      textEl.innerHTML=
        '<textarea id="edit-'+id+'" class="note-input" style="min-height:80px;">'+escapeHtml(original)+'</textarea>'+
        '<div class="input-row" style="margin-top:.5rem;">'+
          '<button class="btn" data-action="save-edit">Save</button>'+
          '<button class="btn btn-secondary" data-action="cancel-edit">Cancel</button>'+
        '</div>';
      $("edit-"+id).focus();
    }
    function saveNoteEdit(id){
      var ta=$("edit-"+id); if(!ta) return;
      var n=appState.notes.find(function(x){return x.id===id}); if(!n) return;
      var txt=ta.value.trim(); if(txt) n.text=txt;
      renderNotes();
      if(appState.currentTab==="report") generateReport();
    }
    function cancelNoteEdit(){ renderNotes(); }
    function notesListClick(e){
      var btn=e.target.closest("[data-action]"); if(!btn) return;
      var item=e.target.closest(".note-item"); var id=parseInt(item.dataset.noteId,10);
      var action=btn.getAttribute("data-action");
      if(action==="delete-note") deleteNote(id);
      else if(action==="edit-note") editNoteInline(id);
      else if(action==="save-edit") saveNoteEdit(id);
      else if(action==="cancel-edit") cancelNoteEdit();
      else if(action==="save-followup") addFollowUp(id);
    }

    function renderNotes(){
      var list=$("notesList");
      if(appState.notes.length===0){
        list.innerHTML='<div class="status-message status-info">No notes yet. Add your first note above!</div>';
        return;
      }
      list.innerHTML = appState.notes.map(function(n){
        var t=formatTimestamp(n.timestamp);
        var toStr=n.includeTo?(" | To: "+escapeHtml(n.to)):"";
        var fromStr=n.includeFrom?(" | From: "+escapeHtml(n.from)):"";
        var fuBadge=(n.followUp||n.followUps.length)?'<span class="badge" title="Requires Follow Up">FOLLOW UP</span>':"";
        var followUpEntryBox = (n.followUp || n.followUps.length)
          ? (
            '<div class="followup-box" style="margin-top:.5rem;background:#252525;border:1px solid #444;border-radius:6px;padding:.5rem;">' +
              '<label for="fu-input-'+n.id+'" style="display:block;color:#ddd;font-size:.85rem;margin-bottom:.35rem;">Add Follow Up detail</label>' +
              '<textarea id="fu-input-'+n.id+'" style="width:100%;min-height:70px;padding:.5rem;border:1px solid #444;border-radius:6px;background:#1f1f1f;color:#fff;"></textarea>' +
              '<div style="display:flex;justify-content:flex-end;margin-top:.4rem;"><button class="btn btn-xs" data-action="save-followup">Save Follow Up</button></div>' +
            '</div>'
          ) : "";
        var followUpBullets = n.followUps.length
          ? ('<ul style="margin:.6rem 0 0 .95rem;color:#111;">' +
              n.followUps.map(function(fu){
                return '<li style="margin:.25rem 0;font-size:.92rem;color:#fff;">' +
                         '<span style="font-weight:700;color:#ffcc66;">'+formatTimestamp(fu.ts)+'</span> ‚Äî ' +
                         '<span>'+escapeHtml(fu.text)+'</span>' +
                       '</li>';
              }).join("") +
             '</ul>')
          : "";
        return (
          '<div class="note-item" data-note-id="'+n.id+'">' +
            '<div class="note-header" style="background:#333;padding:.6rem .75rem;display:flex;justify-content:space-between;align-items:center;">' +
              '<div class="note-timestamp" style="color:#ffcc66;font-weight:700;font-size:.9rem;">'+t+fromStr+toStr+fuBadge+'</div>' +
              '<div class="note-actions" style="display:flex;gap:.5rem;">' +
                '<button class="note-action-btn" data-action="edit-note" title="Edit" style="background:none;border:none;color:#ccc;cursor:pointer;font-size:1rem;">‚úèÔ∏è</button>' +
                '<button class="note-action-btn" data-action="delete-note" title="Delete" style="background:none;border:none;color:#ccc;cursor:pointer;font-size:1rem;">üóëÔ∏è</button>' +
              '</div>' +
            '</div>' +
            '<div class="note-content" style="padding:.75rem;border-top:1px solid #444;">' +
              '<div id="note-text-'+n.id+'" class="note-text" style="white-space:pre-wrap;line-height:1.45;">'+escapeHtml(n.text)+'</div>' +
              followUpEntryBox +
              followUpBullets +
            '</div>' +
          '</div>'
        );
      }).join("");
    }

    // Report generation with pagination and page navigation
    function generateReport(){
      var prev=$("reportPreview");
      if(appState.notes.length===0){
        prev.innerHTML='<div class="status-message status-info">Add notes to generate a report.</div>';
        toggleReportButtons(false);
        hide($("pager"));
        return;
      }

      var searchTerm=($("reportSearchInput").value||"").toLowerCase().trim();
      var sourceNotes=appState.notes.slice().reverse().filter(function(n){
        if(!searchTerm) return true;
        return (n.text||"").toLowerCase().includes(searchTerm) ||
               (n.includeFrom?(n.from||"").toLowerCase().includes(searchTerm):false) ||
               (n.includeTo?(n.to||"").toLowerCase().includes(searchTerm):false) ||
               formatTimestamp(n.timestamp).toLowerCase().includes(searchTerm) ||
               n.followUps.some(function(fu){return (fu.text||"").toLowerCase().includes(searchTerm)});
      });

      var incNumber=appState.noIncident?"":appState.incidentNumber;
      var incName=appState.incidentName||"";
      var dateStr=new Date().toLocaleDateString("en-GB");
      var dfesId=appState.dfesId;
      var author=appState.author;
      var role=appState.role;

      var rowsPerPage=22; // fits A4 landscape comfortably
      var pages=[]; for(var i=0;i<sourceNotes.length;i+=rowsPerPage){pages.push(sourceNotes.slice(i,i+rowsPerPage));}
      var startPage=appState.diaryPageStart!=null?appState.diaryPageStart:1;

      appState.reportPages = pages.map(function(chunk,pageIndex){
        var pageNumberPadded=pad6(startPage+pageIndex);
        var rowsHtml=chunk.map(function(n){
          var datetime=formatTimestamp(n.timestamp);
          var from=n.includeFrom?escapeHtml(n.from):"";
          var to=n.includeTo?escapeHtml(n.to):"";
          var bullets = n.followUps.length
            ? ('<ul style="margin:.4rem 0 0 1rem; padding:0;">' +
                n.followUps.map(function(fu){
                  return '<li style="margin:.2rem 0; font-size:12px; color:#222;"><span style="font-weight:700; color:#555;">'+formatTimestamp(fu.ts)+'</span> ‚Äî '+escapeHtml(fu.text)+'</li>';
                }).join("") +
               '</ul>')
            : "";
          var noteText = escapeHtml(n.text) + bullets;
          return '<tr><td class="col-datetime">'+datetime+'</td><td class="col-from">'+from+'</td><td class="col-to">'+to+'</td><td>'+noteText+'</td></tr>';
        }).join("");

        var metaTable =
          '<table class="meta-table" aria-label="Incident meta">' +
            '<colgroup><col><col><col><col><col><col></colgroup>' +
            '<tbody>' +
              '<tr>' +
                '<th class="meta-label">INCIDENT NAME:</th><td class="meta-value">'+(incName||"&nbsp;")+'</td>' +
                '<th class="meta-label">INCIDENT No.:</th><td class="meta-value">'+(incNumber||"&nbsp;")+'</td>' +
                '<th class="meta-label">DATE:</th><td class="meta-value">'+dateStr+'</td>' +
              '</tr>' +
              '<tr>' +
                '<th class="meta-label">NAME:</th><td class="meta-value">'+escapeHtml(author)+'</td>' +
                '<th class="meta-label">ROLE:</th><td class="meta-value">'+escapeHtml(role)+'</td>' +
                '<th class="meta-label">SERVICE No:</th><td class="meta-value">'+escapeHtml(dfesId)+'</td>' +
              '</tr>' +
            '</tbody>' +
          '</table>';

        return (
          '<section class="dfes-sheet" data-page="'+(startPage+pageIndex)+'" style="'+(pageIndex<pages.length-1?'page-break-after: always;':'')+'">' +
            '<div class="dfes-title">PERSONAL INCIDENT DIARY</div>' +
            '<div class="dfes-page-row"><div></div><div class="dfes-page">PAGE: <span class="num">'+pageNumberPadded+'</span></div></div>' +
            metaTable +
            '<table class="dfes-grid" role="table" aria-label="Incident diary grid">' +
              '<thead><tr><th class="col-datetime">DATE & TIME</th><th class="col-from">FROM</th><th class="col-to">TO</th><th>NOTE</th></tr></thead>' +
              '<tbody>'+(rowsHtml||'<tr><td colspan="4" style="text-align:center;color:#666;">No entries</td></tr>')+'</tbody>' +
            '</table>' +
          '</section>'
        );
      });

      appState.currentReportPageIndex = 0;
      renderReportPage();
      toggleReportButtons(true);

      // Show pager if more than 1 page
      if (appState.reportPages.length > 1) {
        show($("pager"));
        updatePagerInfo();
      } else {
        hide($("pager"));
      }
    }

    function renderReportPage(){
      var prev=$("reportPreview");
      if(appState.reportPages.length===0){ prev.innerHTML=''; return; }
      // In preview, show only the current page for clarity
      prev.innerHTML = appState.reportPages[appState.currentReportPageIndex];
    }

    function updatePagerInfo(){
      $("pagerInfo").textContent = "Page " + (appState.currentReportPageIndex+1) + " of " + appState.reportPages.length;
      $("prevPageBtn").disabled = appState.currentReportPageIndex===0;
      $("nextPageBtn").disabled = appState.currentReportPageIndex===appState.reportPages.length-1;
    }

    function changeReportPage(delta){
      var idx = appState.currentReportPageIndex + delta;
      if (idx < 0 || idx >= appState.reportPages.length) return;
      appState.currentReportPageIndex = idx;
      renderReportPage();
      updatePagerInfo();
    }

    function toggleReportButtons(enabled){
      ["downloadPdfBtn","emailBtn"].forEach(function(id){
        var b=$(id); if(b) b.disabled=!enabled;
      });
    }

    function printToPdf(){
      // Print all pages sequentially
      var w=window.open("","_blank");
      var html="<!DOCTYPE html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1.0'>" +
               "<style>"+document.querySelector("style").innerHTML+"</style>" +
               "<title>Incident Diary Report</title></head><body>" +
               appState.reportPages.join("") +
               "</body></html>";
      w.document.write(html);
      w.document.close();
      w.onload=function(){w.print(); w.close();};
    }

    function emailReport(){
      var subject=encodeURIComponent("Incident Report"+(appState.incidentNumber?" - "+appState.incidentNumber:""));
      var body=encodeURIComponent(generateEmailBody());
      window.location.href="mailto:?subject="+subject+"&body="+body;
    }
    function generateEmailBody(){
      var lines=[]; var dateStr=new Date().toLocaleDateString("en-GB");
      lines.push("PERSONAL INCIDENT DIARY (Landscape)");
      lines.push("Incident Name: "+(appState.incidentName||""));
      lines.push("Incident No: "+(appState.noIncident?"N/A":appState.incidentNumber));
      lines.push("Date: "+dateStr);
      lines.push("Name: "+appState.author);
      lines.push("Role: "+appState.role);
      lines.push("Service No: "+appState.dfesId);
      lines.push("Start Page: "+pad6(appState.diaryPageStart!=null?appState.diaryPageStart:1));
      lines.push("");
      appState.notes.slice().reverse().forEach(function(n){
        lines.push("Date & Time: "+formatTimestamp(n.timestamp)+" | From: "+(n.includeFrom?n.from:"")+" | To: "+(n.includeTo?n.to:""));
        lines.push(n.text);
        n.followUps.forEach(function(fu){
          lines.push(" - "+formatTimestamp(fu.ts)+": "+fu.text);
        });
        lines.push("");
      });
      return lines.join("\n");
    }

    function clearAllData(){
      if(!confirm("Clear all data?")) return;
      appState={author:"",incidentName:"",incidentNumber:"",noIncident:false,dfesId:"",role:"",diaryPageStart:null,notes:[],currentTab:"setup",isRecording:false,recognition:appState.recognition,voiceTranscript:"",reportPages:[],currentReportPageIndex:0};
      $("setupForm").reset();
      $("noteInput").value="";
      $("includeFrom").checked=true;
      $("includeTo").checked=true;
      $("incidentInfo").textContent="Incident Logger - Set up your incident details";
      $("notes-btn").disabled=true;
      $("report-btn").disabled=true;
      switchTab("setup");
      $("notesList").innerHTML='<div class="status-message status-info">No notes yet. Add your first note above!</div>';
      $("reportPreview").innerHTML='<div class="status-message status-info">Complete setup and add notes to generate a report.</div>';
      hide($("pager"));
    }

    // Voice-to-Text (optional)
    function setupSpeechRecognition(){
      var SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      var voiceBtn=$("voiceBtn");
      if(!SR){
        if(voiceBtn){voiceBtn.disabled=true;voiceBtn.textContent="üé§ Not Supported";voiceBtn.title="Use Chrome/Edge over HTTPS";}
        return;
      }
      var recognition=new SR(); recognition.continuous=true; recognition.interimResults=true; recognition.lang="en-AU";
      var isActive=false; var finalText="";
      function start(){ if(isActive) return; finalText=""; try{recognition.start();}catch(e){} }
      function stop(){ if(!isActive) return; try{recognition.stop();}catch(e){} }
      if(voiceBtn){voiceBtn.addEventListener("click",function(){ if(isActive) stop(); else start(); });}
      recognition.onstart=function(){ isActive=true; if(voiceBtn){voiceBtn.classList.add("recording");voiceBtn.textContent="üî¥ Recording...";} showStatus("voiceStatus","Listening...","info"); };
      recognition.onresult=function(ev){ var interim=""; for(var i=ev.resultIndex;i<ev.results.length;i++){ var t=ev.results[i][0].transcript; if(ev.results[i].isFinal) finalText+=t+" "; else interim+=t; } if(interim) showStatus("voiceStatus","Interim: "+interim,"info"); if(finalText.trim()){$("noteInput").value=finalText.trim();} };
      recognition.onerror=function(e){ showStatus("voiceStatus","Voice error: "+e.error,"error"); isActive=false; if(voiceBtn){voiceBtn.classList.remove("recording");voiceBtn.textContent="üé§ Voice";} };
      recognition.onend=function(){ isActive=false; if(voiceBtn){voiceBtn.classList.remove("recording");voiceBtn.textContent="üé§ Voice";} var box=$("noteInput"); if(box&&finalText.trim()){ box.value=finalText.trim(); showStatus("voiceStatus","Transcript ready. Click Add Note.","success"); setTimeout(function(){hideStatus("voiceStatus")},2000);} };
      appState.recognition=recognition;
    }

    // Mic permission helper
    async function requestMicrophoneAccess(){
      var statusId="micAssistStatus";
      try{
        if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){showStatus(statusId,"Your browser does not support microphone access via getUserMedia. Use Chrome on HTTPS.","error");return;}
        const stream=await navigator.mediaDevices.getUserMedia({audio:true});
        stream.getTracks().forEach(function(t){t.stop()});
        showStatus(statusId,"Microphone is enabled.","success");
        setTimeout(function(){hideStatus(statusId)},2000);
      }catch(err){
        showStatus(statusId,"Unable to access microphone: "+(err&&err.name?err.name:"unknown"),"error");
      }
    }
  </script>
</body>
</html>

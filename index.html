<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Incident Diary Pro (No Storage, No Photo)</title>
    <style>
        /* Reset */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(90deg, #ff4444 0%, #cc3333 100%);
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; }
        .incident-info { font-size: 0.9rem; opacity: 0.9; }

        /* Tab Navigation */
        .tab-nav { display: flex; background: #333; border-bottom: 2px solid #ff4444; }
        .tab-btn {
            flex: 1; padding: 1rem; background: none; border: none; color: #ccc;
            font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; position: relative;
        }
        .tab-btn.active { color: #ff4444; background: #2a2a2a; }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background: #ff4444; }
        .tab-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Tab Content */
        .tab-content { flex: 1; padding: 1rem; display: none; overflow-y: auto; }
        .tab-content.active { display: block; }

        /* Setup Tab */
        .setup-form { max-width: 400px; margin: 0 auto; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #ff4444; font-weight: 600; }
        .form-group input[type="text"] {
            width: 100%; padding: 0.75rem; border: 2px solid #444; border-radius: 8px; background: #2a2a2a; color: #fff; font-size: 1rem;
        }
        .form-group input[type="text"]:focus { outline: none; border-color: #ff4444; box-shadow: 0 0 0 3px rgba(255,68,68,0.2); }

        /* Compact row for incident number + checkbox */
        .incident-row {
            display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; align-items: center;
        }
        .no-incident-checkbox { display: inline-flex; align-items: center; gap: 0.35rem; white-space: nowrap; }
        .no-incident-checkbox input[type="checkbox"] { transform: scale(1.1); }
        .no-incident-checkbox label { color: #ccc; font-size: 0.95rem; cursor: pointer; }

        .btn {
            background: linear-gradient(90deg, #ff4444 0%, #cc3333 100%);
            color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px;
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
            width: 100%; margin-top: 1rem;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255,68,68,0.3); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-danger { background: linear-gradient(90deg, #dc2626 0%, #b91c1c 100%); }
        .btn-danger:hover { box-shadow: 0 4px 15px rgba(220,38,38,0.3); }
        .btn-secondary { background: #444; color: #fff; }
        .btn-secondary:hover { background: #555; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

        /* Notes Tab */
        .notes-controls { margin-bottom: 1rem; }
        .search-container { position: relative; margin-bottom: 1rem; }
        .search-input {
            width: 100%; padding: 0.75rem 2.5rem 0.75rem 1rem; border: 2px solid #444; border-radius: 8px; background: #2a2a2a; color: #fff; font-size: 1rem;
        }
        .search-clear {
            position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%);
            background: none; border: none; color: #ccc; font-size: 1.2rem; cursor: pointer; padding: 0.25rem; display: none;
        }

        .note-input-container { position: relative; margin-bottom: 1rem; }
        .note-input {
            width: 100%; min-height: 100px; padding: 0.75rem; border: 2px solid #444; border-radius: 8px;
            background: #2a2a2a; color: #fff; font-size: 1rem; resize: vertical; font-family: inherit;
        }
        .input-row { display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem; }
        .input-row .btn, .input-row .voice-btn { flex: 1; padding: 0.75rem; font-size: 1rem; }

        .follow-up-input { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; }
        .follow-up-input input[type="checkbox"] { transform: scale(1.2); }
        .follow-up-input label { color: #ff4444; font-weight: 600; }

        .voice-btn {
            background: #444; color: #fff; border: none; border-radius: 6px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; flex: 1;
        }
        .voice-btn.recording { background: #ff4444; animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }

        .notes-list { margin-top: 1rem; }
        .note-item { background: #2a2a2a; border: 1px solid #444; border-radius: 8px; margin-bottom: 1rem; overflow: hidden; transition: all 0.3s ease; }
        .note-item.highlight { border-color: #ff4444; box-shadow: 0 0 10px rgba(255,68,68,0.3); }
        .note-header { background: #333; padding: 0.75rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .note-timestamp { color: #ff4444; font-weight: 600; font-size: 0.9rem; }
        .note-actions { display: flex; gap: 0.5rem; }
        .note-action-btn { background: none; border: none; color: #ccc; cursor: pointer; padding: 0.25rem; font-size: 0.9rem; transition: color 0.3s ease; }
        .note-action-btn:hover { color: #ff4444; }
        .note-content { padding: 0.75rem; display: block; border-top: 1px solid #444; }

        .note-followup-header { margin-bottom: 0.5rem; }
        .note-followup-controls { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .note-followup-checkbox { transform: scale(1.2); }
        .note-followup-input { display: none; margin-top: 0.5rem; padding: 0.5rem; background: #333; border-radius: 4px; border: 1px solid #ff4444; }
        .note-followup-input.active { display: block; }
        .note-followup-details {
            width: 100%; min-height: 60px; padding: 0.5rem; border: 1px solid #444; border-radius: 4px; background: #1a1a1a; color: #fff; font-family: inherit; resize: vertical; margin-bottom: 0.5rem;
        }
        .note-followup-complete { background: #22c55e; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
        .note-followup-complete:hover { background: #16a34a; }

        .follow-up-indicator { color: #ff4444; font-weight: 600; margin-bottom: 0.5rem; }
        .follow-up-details { background: #333; padding: 0.75rem; border-left: 3px solid #ff4444; margin-top: 0.5rem; border-radius: 0 4px 4px 0; }
        .follow-up-timestamp { font-size: 0.8rem; color: #ff4444; margin-bottom: 0.25rem; }
        .note-text { line-height: 1.5; word-wrap: break-word; }
        .note-edit {
            width: 100%; min-height: 80px; padding: 0.5rem; border: 1px solid #444; border-radius: 4px; background: #1a1a1a; color: #fff; font-family: inherit; resize: vertical;
        }

        /* Report Tab */
        .report-preview { background: #2a2a2a; border: 1px solid #444; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; max-height: 60vh; overflow-y: auto; }
        .report-header { text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #ff4444; }
        .report-title { font-size: 1.5rem; color: #ff4444; margin-bottom: 1rem; }
        .report-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; font-size: 0.9rem; }
        .report-download-time { font-size: 0.8rem; color: #ccc; text-align: right; margin-top: 0.5rem; }
        .report-notes { margin-top: 2rem; }
        .report-note { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #444; }
        .report-note:last-child { border-bottom: none; }
        .report-note-time { color: #ff4444; font-weight: 600; margin-bottom: 0.5rem; }
        .report-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }

        /* Status Messages */
        .status-message { padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; text-align: center; font-weight: 600; }
        .status-success { background: rgba(34,197,94,0.2); border: 1px solid #22c55e; color: #22c55e; }
        .status-error   { background: rgba(239,68,68,0.2); border: 1px solid #ef4444; color: #ef4444; }
        .status-info    { background: rgba(59,130,246,0.2); border: 1px solid #3b82f6; color: #3b82f6; }

        /* Print Styles */
        @media print {
            body { background: white; color: black; }
            .tab-nav, .btn, .notes-controls { display: none; }
            .report-preview { background: white; border: none; max-height: none; }
            .report-meta { grid-template-columns: 1fr 1fr 1fr 1fr; }
        }

        /* Responsive Design */
        @media (min-width: 768px) {
            .container { max-width: 768px; margin: 0 auto; border-left: 1px solid #444; border-right: 1px solid #444; }
            .report-meta { grid-template-columns: 1fr 1fr 1fr 1fr; }
            .report-actions { justify-content: center; }
            .btn { width: auto; min-width: 200px; }
        }

        /* Touch-friendly */
        @media (max-width: 767px) {
            .tab-btn { padding: 1.2rem 0.5rem; font-size: 0.8rem; }
            .btn, .voice-btn { padding: 1rem; font-size: 1.1rem; }
            .note-header { padding: 1rem; }
            .note-action-btn { padding: 0.5rem; font-size: 1rem; }
            .input-row { flex-direction: column; align-items: stretch; }
            .voice-btn { flex: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>Incident Diary Pro</h1>
            <div class="incident-info" id="incidentInfo">
                Incident Logger - Set up your incident details
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="tab-nav" role="tablist">
            <button class="tab-btn active" role="tab" aria-selected="true" aria-controls="setup-tab" id="setup-btn">üìã Setup</button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="notes-tab" id="notes-btn" disabled>üìù Notes</button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="report-tab" id="report-btn" disabled>üìÑ Report</button>
        </nav>

        <!-- Setup Tab -->
        <main class="tab-content active" id="setup-tab" role="tabpanel" aria-labelledby="setup-btn">
            <form class="setup-form" id="setupForm">
                <div class="form-group">
                    <label for="authorName">Author Name *</label>
                    <input type="text" id="authorName" name="authorName" required placeholder="Enter your full name" autocomplete="name" />
                </div>

                <div class="form-group">
                    <label for="incidentNumber">Incident Number</label>
                    <div class="incident-row">
                        <input type="text" id="incidentNumber" name="incidentNumber" placeholder="e.g 621223" autocomplete="off" />
                        <div class="no-incident-checkbox">
                            <input type="checkbox" id="noIncidentCheckbox" />
                            <label for="noIncidentCheckbox">No Incident Number</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="dfesId">DFES ID Number *</label>
                    <input type="text" id="dfesId" name="dfesId" required placeholder="e.g., 123456" autocomplete="off" />
                </div>

                <div class="form-group">
                    <label for="userRole">Your Role *</label>
                    <input type="text" id="userRole" name="userRole" required placeholder="e.g., RDC, IC, OO, PO, PIO, LO" autocomplete="organization-title" />
                </div>

                <button type="submit" class="btn" id="submitBtn">Start Logging Notes</button>
            </form>
            <div id="setupStatus" class="status-message" style="display: none;"></div>
        </main>

        <!-- Notes Tab -->
        <main class="tab-content" id="notes-tab" role="tabpanel" aria-labelledby="notes-btn">
            <div class="notes-controls">
                <div class="note-input-container">
                    <textarea class="note-input" id="noteInput" placeholder="Enter your note here..." aria-label="Note content"></textarea>

                    <div class="input-row">
                        <button class="voice-btn" id="voiceBtn" aria-label="Start voice recording">üé§ Voice</button>
                        <!-- Photo option removed -->
                        <button class="btn" id="addNoteBtn">Add Note</button>
                    </div>

                    <div class="follow-up-input">
                        <input type="checkbox" id="followUpCheckbox" />
                        <label for="followUpCheckbox">Requires Follow Up</label>
                    </div>
                </div>

                <div id="voiceStatus" class="status-message" style="display: none;"></div>

                <div class="search-container">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search notes by keyword..." aria-label="Search notes" />
                    <button class="search-clear" id="searchClear" aria-label="Clear search">√ó</button>
                </div>
            </div>

            <div class="notes-list" id="notesList" role="region" aria-label="Notes list">
                <div class="status-message status-info">No notes yet. Add your first note above!</div>
            </div>
        </main>

        <!-- Report Tab -->
        <main class="tab-content" id="report-tab" role="tabpanel" aria-labelledby="report-btn">
            <div class="report-preview" id="reportPreview">
                <div class="status-message status-info">Complete setup and add notes to generate a report.</div>
            </div>

            <div class="report-actions">
                <button class="btn btn-secondary" id="downloadPdfBtn" disabled>üñ®Ô∏è Print to PDF</button>
                <button class="btn btn-secondary" id="emailBtn" disabled>üìß Email Report</button>
                <button class="btn btn-danger" id="clearDataBtn">üóëÔ∏è Clear All Data</button>
            </div>
        </main>
    </div>

    <script>
        // In-memory state (no localStorage)
        let appState = {
            author: '',
            incidentNumber: '',
            noIncident: false,
            dfesId: '',
            role: '',
            notes: [],
            currentTab: 'setup',
            isRecording: false,
            recognition: null,
            voiceTranscript: ''
        };

        function getElement(id) {
            const el = document.getElementById(id);
            if (!el) console.error(`Element with ID '${id}' not found.`);
            return el;
        }

        function init() {
            setupEventListeners();
            setupSpeechRecognition();
            updateUI();
        }

        function setupEventListeners() {
            // Tabs
            getElement('setup-btn').addEventListener('click', () => switchTab('setup'));
            getElement('notes-btn').addEventListener('click', () => switchTab('notes'));
            getElement('report-btn').addEventListener('click', () => switchTab('report'));

            // Setup
            getElement('setupForm').addEventListener('submit', handleSetupSubmit);
            getElement('noIncidentCheckbox').addEventListener('change', handleNoIncidentChange);

            // Notes
            getElement('addNoteBtn').addEventListener('click', addNote);
            getElement('voiceBtn').addEventListener('click', toggleVoiceRecording);
            getElement('noteInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); addNote(); }
            });

            // Search
            getElement('searchInput').addEventListener('input', handleSearch);
            getElement('searchClear').addEventListener('click', clearSearch);

            // Report actions
            getElement('downloadPdfBtn').addEventListener('click', printToPdf);
            getElement('emailBtn').addEventListener('click', emailReport);
            getElement('clearDataBtn').addEventListener('click', clearAllData);

            // Notes list delegation
            getElement('notesList').addEventListener('click', handleNotesListClick);
        }

        function handleNoIncidentChange(e) {
            const incidentInput = getElement('incidentNumber');
            appState.noIncident = e.target.checked;
            if (incidentInput) {
                incidentInput.required = !appState.noIncident;
                incidentInput.disabled = appState.noIncident;
                if (appState.noIncident) incidentInput.value = '';
            }
        }

        // Speech recognition (optional)
        function setupSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                const voiceBtn = getElement('voiceBtn');
                if (voiceBtn) {
                    voiceBtn.disabled = true;
                    voiceBtn.textContent = 'üé§ Not Supported';
                    voiceBtn.title = 'Speech recognition not supported';
                }
                return;
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            appState.recognition = new SpeechRecognition();
            appState.recognition.continuous = true;
            appState.recognition.interimResults = true;
            appState.recognition.lang = 'en-US';

            appState.recognition.onstart = () => {
                appState.isRecording = true;
                appState.voiceTranscript = '';
                const btn = getElement('voiceBtn');
                btn.classList.add('recording');
                btn.textContent = 'üî¥ Recording...';
                showStatus('voiceStatus', 'Listening... Speak now', 'info');
                getElement('noteInput').value = '';
            };

            appState.recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) appState.voiceTranscript += transcript + ' ';
                    else interimTranscript += transcript;
                }
                if (interimTranscript) showStatus('voiceStatus', `Interim: ${interimTranscript}`, 'info');
            };

            appState.recognition.onerror = (event) => {
                showStatus('voiceStatus', `Error: ${event.error}`, 'error');
                stopVoiceRecording();
            };

            appState.recognition.onend = () => {
                if (appState.voiceTranscript.trim()) {
                    getElement('noteInput').value = appState.voiceTranscript.trim();
                    showStatus('voiceStatus', 'Transcript ready for review!', 'success');
                }
                stopVoiceRecording();
            };
        }

        function toggleVoiceRecording() {
            if (appState.isRecording) appState.recognition.stop();
            else startVoiceRecording();
        }

        function startVoiceRecording() {
            if (appState.recognition && !appState.isRecording) {
                try { appState.recognition.start(); }
                catch { showStatus('voiceStatus', 'Could not start recording', 'error'); }
            }
        }

        function stopVoiceRecording() {
            if (appState.recognition && appState.isRecording) appState.recognition.stop();
            appState.isRecording = false;
            const btn = getElement('voiceBtn');
            btn.classList.remove('recording');
            btn.textContent = 'üé§ Voice';
            setTimeout(() => hideStatus('voiceStatus'), 3000);
        }

        // Tabs
        function switchTab(tabName) {
            if (tabName !== 'setup' && !isSetupComplete()) {
                const statusId = tabName === 'notes' ? 'setupStatus' : 'voiceStatus';
                showStatus(statusId, 'Please complete setup first', 'error');
                return;
            }
            appState.currentTab = tabName;

            document.querySelectorAll('.tab-btn').forEach(btn => {
                const isActive = btn.id === `${tabName}-btn`;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-selected', isActive);
                if (btn.id !== 'setup-btn') btn.disabled = !isSetupComplete();
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `${tabName}-tab`);
            });

            if (tabName === 'notes') renderNotes();
            else if (tabName === 'report') generateReport();
        }

        // Setup
        function handleSetupSubmit(e) {
            e.preventDefault();
            appState.author = getElement('authorName').value.trim();
            appState.incidentNumber = getElement('incidentNumber').value.trim();
            appState.noIncident = getElement('noIncidentCheckbox').checked;
            appState.dfesId = getElement('dfesId').value.trim();
            appState.role = getElement('userRole').value.trim();

            if (isSetupComplete()) {
                updateIncidentInfo();
                switchTab('notes');
                getElement('noteInput').focus();
                showStatus('setupStatus', 'Setup complete!', 'success');
                setTimeout(() => hideStatus('setupStatus'), 3000);
            } else {
                showStatus('setupStatus', 'Please fill all required fields.', 'error');
            }
        }

        function isSetupComplete() {
            return Boolean(
                appState.author &&
                appState.dfesId &&
                appState.role &&
                (appState.noIncident || appState.incidentNumber)
            );
        }

        function updateIncidentInfo() {
            const incNum = appState.noIncident ? 'No Incident Number' : appState.incidentNumber;
            getElement('incidentInfo').textContent = `${incNum} | DFES ID: ${appState.dfesId} | ${appState.author} (${appState.role})`;
        }

        // Notes: follow up allowed only if flagged at creation
        function addNote() {
            const noteText = getElement('noteInput').value.trim();
            const followUpChecked = getElement('followUpCheckbox').checked;
            if (!noteText) return;

            const note = {
                id: Date.now(),
                timestamp: new Date(),
                text: noteText,
                author: appState.author,
                followUp: followUpChecked,
                followUpDetails: '',
                followUpTimestamp: null,
                image: null,      // no photos
                location: null    // no photo location
            };

            appState.notes.unshift(note);
            getElement('noteInput').value = '';
            getElement('followUpCheckbox').checked = false;
            renderNotes();
            showStatus('voiceStatus', 'Note added!', 'success');
            setTimeout(() => hideStatus('voiceStatus'), 2000);
        }

        function deleteNote(noteId) {
            if (confirm('Delete this note?')) {
                appState.notes = appState.notes.filter(n => n.id !== noteId);
                renderNotes();
            }
        }

        function editNote(noteId, newText) {
            const note = appState.notes.find(n => n.id === noteId);
            if (note && newText.trim()) {
                note.text = newText.trim();
                renderNotes(getElement('searchInput').value.toLowerCase());
            }
        }

        function completeFollowUp(noteId) {
            const note = appState.notes.find(n => n.id === noteId);
            if (!note) return;
            if (!note.followUp) {
                showStatus('voiceStatus', 'Follow up not allowed for this note.', 'error');
                return;
            }
            const detailsEl = document.querySelector(`#followup-input-${noteId} .note-followup-details`);
            if (detailsEl) {
                note.followUpDetails = detailsEl.value.trim();
                note.followUpTimestamp = new Date();
                detailsEl.value = '';
                renderNotes(getElement('searchInput').value.toLowerCase());
                showStatus('voiceStatus', 'Follow up completed!', 'success');
                setTimeout(() => hideStatus('voiceStatus'), 2000);
            }
        }

        function toggleNoteFollowUp(noteId, checkbox) {
            const note = appState.notes.find(n => n.id === noteId);
            if (!note) return;
            if (!note.followUp) {
                checkbox.checked = false;
                showStatus('voiceStatus', 'Follow up not allowed for this note.', 'error');
                return;
            }
            const inputContainer = document.getElementById(`followup-input-${noteId}`);
            if (!inputContainer) return;
            const ta = inputContainer.querySelector('textarea');
            if (checkbox.checked) {
                inputContainer.classList.add('active');
                if (ta) ta.focus();
            } else {
                inputContainer.classList.remove('active');
                if (ta) ta.value = '';
            }
        }

        function toggleNoteExpansion(noteId) {
            const content = document.getElementById(`note-content-${noteId}`);
            if (content) content.classList.toggle('expanded');
        }

        function editNoteInline(noteId) {
            const textEl = document.getElementById(`note-text-${noteId}`);
            if (!textEl) return;
            const note = appState.notes.find(n => n.id === noteId);
            const originalText = note ? note.text : '';
            textEl.innerHTML = `
                <textarea class="note-edit" id="edit-${noteId}">${escapeHtml(originalText)}</textarea>
                <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn save-edit-btn" data-action="save-edit" style="width: auto;">Save</button>
                    <button class="btn btn-secondary cancel-edit-btn" data-action="cancel-edit" style="width: auto;">Cancel</button>
                </div>
            `;
            const ta = document.getElementById(`edit-${noteId}`);
            if (ta) ta.focus();
        }

        function saveNoteEdit(noteId) {
            const textarea = document.getElementById(`edit-${noteId}`);
            if (textarea) editNote(noteId, textarea.value.trim());
        }

        function cancelNoteEdit() {
            renderNotes(getElement('searchInput').value.toLowerCase());
        }

        // Search
        function handleSearch() {
            const searchTerm = getElement('searchInput').value.toLowerCase();
            renderNotes(searchTerm);
            getElement('searchClear').style.display = searchTerm ? 'block' : 'none';
        }

        function clearSearch() {
            getElement('searchInput').value = '';
            getElement('searchClear').style.display = 'none';
            renderNotes();
        }

        function highlightSearchTerm(text, searchTerm) {
            const safe = escapeHtml(text || '');
            if (!searchTerm) return safe;
            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return safe.replace(regex, '<mark style="background: #ff4444; color: white; padding: 0 2px;">$1</mark>');
        }

        // Render notes
        function renderNotes(searchTerm = '') {
            let filteredNotes = appState.notes;
            if (searchTerm) {
                filteredNotes = appState.notes.filter(note =>
                    (note.text || '').toLowerCase().includes(searchTerm) ||
                    (note.followUpDetails && note.followUpDetails.toLowerCase().includes(searchTerm))
                );
            }

            const listEl = getElement('notesList');
            if (!listEl) return;

            if (filteredNotes.length === 0) {
                listEl.innerHTML = searchTerm
                    ? '<div class="status-message status-info">No notes found.</div>'
                    : '<div class="status-message status-info">No notes yet. Add your first note above!</div>';
                return;
            }

            listEl.innerHTML = filteredNotes.map(note => {
                const formattedTime = formatTimestamp(note.timestamp);
                const highlightedText = highlightSearchTerm(note.text, searchTerm);
                const isHighlighted = !!searchTerm &&
                    ((note.text || '').toLowerCase().includes(searchTerm) ||
                     (note.followUpDetails && note.followUpDetails.toLowerCase().includes(searchTerm)));

                // Follow-up controls only if originally requested
                let followupControls = '';
                if (note.followUp) {
                    if (!note.followUpDetails) {
                        followupControls = `
                            <div class="note-followup-controls">
                                <input type="checkbox" class="note-followup-checkbox" id="followup-check-${note.id}" data-action="toggle-followup">
                                <label for="followup-check-${note.id}">Follow Up</label>
                            </div>
                            <div class="note-followup-input" id="followup-input-${note.id}">
                                <textarea class="note-followup-details" placeholder="Enter follow up details..."></textarea>
                                <button class="note-followup-complete" data-action="complete-followup">Complete</button>
                            </div>
                        `;
                    } else {
                        followupControls = `<div class="follow-up-indicator">üîÑ Follow Up Completed</div>`;
                    }
                }

                let noteHtml = `
                    <div class="note-item ${isHighlighted ? 'highlight' : ''}" data-note-id="${note.id}">
                        <div class="note-header" data-action="toggle-expand">
                            <div class="note-timestamp">${formattedTime}</div>
                            <div class="note-actions">
                                <button class="note-action-btn edit-btn" data-action="edit-note" aria-label="Edit" title="Edit">‚úèÔ∏è</button>
                                <button class="note-action-btn delete-btn" data-action="delete-note" aria-label="Delete" title="Delete">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="note-content" id="note-content-${note.id}">
                            ${followupControls ? `<div class="note-followup-header">${followupControls}</div>` : ''}
                            <div class="note-text" id="note-text-${note.id}">${highlightedText}</div>`;

                // Photo/location display removed (no photos)

                if (note.followUp && note.followUpDetails) {
                    const fuTime = formatTimestamp(note.followUpTimestamp);
                    noteHtml += `<div class="follow-up-details">
                        <div class="follow-up-timestamp">${fuTime}</div>
                        <div>${escapeHtml(note.followUpDetails)}</div>
                    </div>`;
                }

                noteHtml += `</div></div>`;
                return noteHtml;
            }).join('');
        }

        // Report
        function generateReport() {
            const previewEl = getElement('reportPreview');
            if (!previewEl) return;

            if (!isSetupComplete() || appState.notes.length === 0) {
                previewEl.innerHTML = '<div class="status-message status-info">Add notes to generate report.</div>';
                setReportButtonsEnabled(false);
                return;
            }

            const reportDate = new Date().toLocaleDateString('en-GB');
            const downloadTime = formatTimestamp(new Date(), true);
            const totalNotes = appState.notes.length;
            const incNum = appState.noIncident ? 'No set Incident Number' : appState.incidentNumber;

            const notesHtml = appState.notes.slice().reverse().map((note) => {
                const time = formatTimestamp(note.timestamp);
                let content = `<div class="report-note">
                    <div class="report-note-time">${time}</div>
                    <div class="note-text">${escapeHtml(note.text)}</div>`;
                if (note.followUp) {
                    content += `<div style="color: #ff4444; font-weight: 600; margin-top: 0.5rem;">üîÑ Follow Up Required</div>`;
                    if (note.followUpDetails) {
                        const fuTime = formatTimestamp(note.followUpTimestamp);
                        content += `<div style="margin-top: 0.5rem; padding: 0.5rem; background: #333; border-left: 3px solid #ff4444;">
                            <div style="font-size: 0.9rem;">${fuTime}</div>
                            <div>${escapeHtml(note.followUpDetails)}</div>
                        </div>`;
                    }
                }
                return content + '</div>';
            }).join('');

            previewEl.innerHTML = `
                <div class="report-header">
                    <h2 class="report-title">Incident Report</h2>
                    <div class="report-meta">
                        <div><strong>Incident:</strong> ${incNum}</div>
                        <div><strong>DFES ID:</strong> ${appState.dfesId}</div>
                        <div><strong>Author:</strong> ${appState.author}</div>
                        <div><strong>Role:</strong> ${appState.role}</div>
                        <div><strong>Date:</strong> ${reportDate}</div>
                        <div><strong>Total Notes:</strong> ${totalNotes}</div>
                    </div>
                    <div class="report-download-time">Report Generated: ${downloadTime}</div>
                </div>
                <div class="report-notes">
                    <h3 style="color: #ff4444; margin-bottom: 1rem;">Incident Notes</h3>
                    ${notesHtml}
                </div>
            `;

            setReportButtonsEnabled(true);
        }

        function setReportButtonsEnabled(enabled) {
            ['downloadPdfBtn', 'emailBtn', 'clearDataBtn'].forEach(id => {
                const btn = getElement(id);
                if (btn && id !== 'clearDataBtn') btn.disabled = !enabled;
            });
        }

        // Export/Share
        function printToPdf() {
            const printWindow = window.open('', '_blank');
            const incNum = appState.noIncident ? 'No set Incident Number' : appState.incidentNumber;
            const html = generatePrintableHTML(incNum);
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.onload = () => {
                printWindow.print();
                printWindow.close();
            };
        }

        function generatePrintableHTML(incNum) {
            const downloadTime = formatTimestamp(new Date(), true);
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8" />
                    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
                    <title>Incident Report PDF - ${incNum}</title>
                    <style>
                        @media print { body { margin: 0; } }
                        body { font-family: Arial, Helvetica, sans-serif; padding: 20px; }
                        h2 { color: #cc3333; }
                        .meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
                        .note { margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; page-break-inside: avoid; }
                        .time { color: #cc3333; font-weight: bold; }
                        .follow-up { color: #cc3333; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h2>Incident Report</h2>
                    <div class="meta">
                        <div><strong>Incident:</strong> ${incNum}</div>
                        <div><strong>DFES ID:</strong> ${appState.dfesId}</div>
                        <div><strong>Author:</strong> ${appState.author}</div>
                        <div><strong>Role:</strong> ${appState.role}</div>
                        <div><strong>Date:</strong> ${new Date().toLocaleDateString('en-GB')}</div>
                        <div><strong>Total Notes:</strong> ${appState.notes.length}</div>
                        <div><strong>Downloaded:</strong> ${downloadTime}</div>
                    </div>
                    <h3>Incident Notes</h3>
                    ${appState.notes.slice().reverse().map((note) => {
                        const time = formatTimestamp(note.timestamp);
                        let content = `<div class="note">
                            <div class="time">${time}</div>
                            <p>${escapeHtml(note.text)}</p>`;
                        if (note.followUp) {
                            content += '<div class="follow-up">Follow Up Required</div>';
                            if (note.followUpDetails) {
                                const fuTime = formatTimestamp(note.followUpTimestamp);
                                content += `<div><strong>${fuTime}</strong><br>${escapeHtml(note.followUpDetails)}</div>`;
                            }
                        }
                        content += '</div>';
                        return content;
                    }).join('')}
                </body>
                </html>
            `;
        }

        function emailReport() {
            const subject = encodeURIComponent(`Incident Report - ${appState.noIncident ? 'No Number' : appState.incidentNumber}`);
            const body = encodeURIComponent(generateEmailBody());
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        function generateEmailBody() {
            const incNum = appState.noIncident ? 'No set Incident Number' : appState.incidentNumber;
            const header = `Incident: ${incNum}\nDFES ID: ${appState.dfesId}\nAuthor: ${appState.author}\nRole: ${appState.role}\nDate: ${new Date().toLocaleDateString('en-GB')}\n\nNotes:\n`;
            const notes = appState.notes.slice().reverse().map(n => {
                const t = formatTimestamp(n.timestamp);
                let s = `- ${t}\n  ${n.text}`;
                if (n.followUp) {
                    s += `\n  Follow Up Required`;
                    if (n.followUpDetails) {
                        const ft = formatTimestamp(n.followUpTimestamp);
                        s += `\n  ${ft}\n  ${n.followUpDetails}`;
                    }
                }
                return s;
            }).join('\n\n');
            return `${header}${notes}`;
        }

        function clearAllData() {
            if (confirm('Are you sure you want to reset all data and remove all notes?')) {
                appState = {
                    author: '', incidentNumber: '', noIncident: false, dfesId: '',
                    role: '', notes: [], currentTab: 'setup', isRecording: false,
                    recognition: appState.recognition,
                    voiceTranscript: ''
                };
                getElement('setupForm').reset();
                getElement('noteInput').value = '';
                getElement('searchInput').value = '';
                getElement('followUpCheckbox').checked = false;
                getElement('incidentInfo').textContent = 'Incident Logger - Set up your incident details';
                switchTab('setup');
                renderNotes();
                generateReport();
                showStatus('voiceStatus', 'All data cleared (not persisted).', 'success');
                setTimeout(() => hideStatus('voiceStatus'), 2000);
            }
        }

        // Utilities
        function formatTimestamp(timestamp, forDownload = false) {
            const date = new Date(timestamp || new Date());
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = forDownload ? `:${String(date.getSeconds()).padStart(2, '0')}` : '';
            return `${day}/${month}/${year} ${hours}:${minutes}${seconds}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text != null ? String(text) : '';
            return div.innerHTML;
        }

        function showStatus(statusId, message, type) {
            const el = getElement(statusId);
            if (el) {
                el.textContent = message;
                el.className = `status-message status-${type}`;
                el.style.display = 'block';
            }
        }

        function hideStatus(statusId) {
            const el = getElement(statusId);
            if (el) el.style.display = 'none';
        }

        function updateUI() {
            const isComplete = isSetupComplete();
            getElement('notes-btn').disabled = !isComplete;
            getElement('report-btn').disabled = !isComplete;
            if (isComplete) switchTab(appState.currentTab || 'notes');
        }

        // Delegation
        function handleNotesListClick(e) {
            const target = e.target;
            const noteItem = target.closest('.note-item');
            if (!noteItem) return;
            const noteId = parseInt(noteItem.dataset.noteId, 10);
            const actionEl = target.closest('[data-action]');
            const action = actionEl ? actionEl.getAttribute('data-action') : null;

            switch (action) {
                case 'edit-note':
                    e.stopPropagation();
                    editNoteInline(noteId);
                    return;
                case 'delete-note':
                    e.stopPropagation();
                    deleteNote(noteId);
                    return;
                case 'toggle-followup':
                    e.stopPropagation();
                    toggleNoteFollowUp(noteId, actionEl);
                    return;
                case 'complete-followup':
                    e.stopPropagation();
                    completeFollowUp(noteId);
                    return;
                case 'save-edit':
                    e.stopPropagation();
                    saveNoteEdit(noteId);
                    return;
                case 'cancel-edit':
                    e.stopPropagation();
                    cancelNoteEdit(noteId);
                    return;
                case 'toggle-expand':
                    toggleNoteExpansion(noteId);
                    return;
                default:
                    return;
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Incident Diary Pro ‚Äî DFES Grid Report</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
      color: #fff;
      min-height: 100%;
    }
    .container { max-width: 100%; min-height: 100vh; display: flex; flex-direction: column; }

    .header { background: linear-gradient(90deg, #ff4444, #cc3333); padding: 1rem; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    .header h1 { font-size: 1.5rem; font-weight: 700; }
    .incident-info { margin-top: .25rem; font-size: .9rem; opacity: .9; }

    .tab-nav { display: flex; background: #333; border-bottom: 2px solid #ff4444; }
    .tab-btn { flex: 1; padding: 1rem; background: none; border: none; color: #ccc; font-weight: 600; cursor: pointer; transition: .2s; position: relative; font-size: .9rem; }
    .tab-btn.active { color: #ff4444; background: #2a2a2a; }
    .tab-btn.active::after { content:""; position: absolute; bottom:-2px; left:0; right:0; height:2px; background:#ff4444; }
    .tab-btn:disabled { opacity:.5; cursor: not-allowed; }
    .tab-content { display: none; padding: 1rem; flex: 1; overflow-y: auto; }
    .tab-content.active { display: block; }

    .btn {
      background: linear-gradient(90deg, #ff4444, #cc3333);
      color: #fff; border: none; border-radius: 8px; padding: .75rem 1.25rem;
      font-weight: 700; cursor: pointer; transition: .2s; width: 100%; margin-top: 1rem; font-size: 1rem;
    }
    .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,68,68,.25); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn-secondary { background: #444; }
    .btn-danger { background: linear-gradient(90deg, #dc2626, #b91c1c); }

    .setup-form { max-width: 560px; margin: 0 auto; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display:block; margin-bottom: .5rem; color:#ff6666; font-weight:700; }
    .form-group input[type="text"], .form-group input[type="number"] {
      width: 100%; padding: .75rem; border: 2px solid #444; border-radius: 8px; background: #2a2a2a; color: #fff;
    }
    .form-group input:focus { outline:none; border-color:#ff4444; box-shadow:0 0 0 3px rgba(255,68,68,.2); }

    .incident-row { display: grid; grid-template-columns: 1fr auto; gap: .5rem; align-items: center; }
    .no-incident-checkbox { display: inline-flex; align-items: center; gap: .35rem; white-space: nowrap; color:#ccc; }

    .note-input { width:100%; min-height:100px; padding:.75rem; border:2px solid #444; border-radius:8px; background:#2a2a2a; color:#fff; resize:vertical; }
    .input-row { display:flex; gap:.5rem; margin-top:.5rem; }
    .voice-btn { background:#444; color:#fff; border:none; border-radius:6px; padding:.75rem; font-weight:600; }
    .voice-btn.recording { background:#ff4444; animation:pulse 1s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.7} }

    .tofrom-panel { display: grid; grid-template-columns: 1fr; gap:.5rem; margin-top: .75rem; background:#252525; border:1px solid #444; border-radius:8px; padding:.75rem; }
    .tofrom-row { display:grid; grid-template-columns: auto 1fr auto 1fr; gap:.5rem; align-items:center; }
    .tofrom-row label { color:#ddd; font-size:.9rem; }
    .tofrom-row input[type="text"] { width:100%; padding:.5rem; border:1px solid #444; border-radius:6px; background:#1f1f1f; color:#fff; }
    .tofrom-checks { display:flex; gap:1rem; align-items:center; flex-wrap: wrap; }
    .tofrom-checks label { display:flex; align-items:center; gap:.35rem; color:#bbb; }

    .status-message { padding:.75rem; border-radius:6px; margin:.75rem 0; text-align:center; font-weight:700; }
    .status-info { background: rgba(59,130,246,.15); border:1px solid #3b82f6; color:#90b4ff; }
    .status-success { background: rgba(34,197,94,.15); border:1px solid #22c55e; color:#6ee7b7; }
    .status-error { background: rgba(239,68,68,.15); border:1px solid #ef4444; color:#fda4af; }

    .report-controls { max-width: 1300px; margin: 0 auto 8px; display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; justify-content:center; }
    .report-search { position:relative; width: min(100%, 800px); }
    .report-search input {
      width:100%; padding:.65rem 2.25rem .65rem .75rem; border:1px solid #888; border-radius:6px;
      background:#fff; color:#000;
    }
    .report-search button {
      position:absolute; right:.25rem; top:50%; transform:translateY(-50%);
      background:#eee; border:1px solid #bbb; padding:.3rem .6rem; border-radius:4px; cursor:pointer;
    }

    .report-preview {
      background:#fff; color:#000; border-radius:8px; padding:12px; border:1px solid #444;
      max-width: 1300px; margin: 0 auto 1rem; overflow:auto;
    }

    :root{
      --grid-font: "Arial", sans-serif;
      --grid-title-size: 18px;
      --grid-label-size: 12px;
      --grid-cell-size: 13px;
      --grid-border: #666;
      --grid-page-number: #d12a2a;
      --col-datetime: 140px;
      --col-from: 130px;
      --col-to: 130px;
      --col-note: auto;
    }

    .dfes-sheet { font-family: var(--grid-font); background:#fff; color:#000; border: 1px solid var(--grid-border); padding: 12px; }
    .dfes-title { text-align:center; font-weight: 800; font-size: var(--grid-title-size); }

    .dfes-page-row {
      display:grid; grid-template-columns: 1fr auto; align-items:center;
      border-bottom: 1px solid var(--grid-border); padding-bottom: 6px; margin: 6px 0;
    }
    .dfes-page { text-align:right; font-size: var(--grid-label-size); }
    .dfes-page .num { color: var(--grid-page-number); font-weight: 800; }

    .dfes-meta6 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-auto-rows: minmax(38px, auto);
      gap: 6px;
      margin: 8px 0 10px 0;
    }
    .field { border:1px solid var(--grid-border); font-size: var(--grid-label-size); display:grid; grid-template-rows: auto auto; background:#fff; }
    .field .label { padding: 4px 6px; border-bottom:1px solid var(--grid-border); background:#f6f6f6; font-weight:700; }
    .field .value { padding: 6px 6px; font-weight: 700; }

    .dfes-grid { margin-top: 6px; border: 1px solid var(--grid-border); border-collapse: collapse; width:100%; table-layout: fixed; }
    .dfes-grid th, .dfes-grid td { border:1px solid var(--grid-border); padding: 4px 6px; font-size: var(--grid-cell-size); vertical-align: top; }
    .dfes-grid thead th { background:#f6f6f6; font-weight:700; }
    .col-datetime { width: var(--col-datetime); }
    .col-from { width: var(--col-from); }
    .col-to { width: var(--col-to); }

    @media print {
      body { background:#fff; color:#000; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .tab-nav, .btn, .notes-controls, .status-message, .report-controls { display: none !important; }
      .report-preview { border:none; padding:0; margin:0; max-width:none; }
      @page { size: A4 landscape; margin: 12mm; }
    }

    @media (max-width: 767px) {
      .tab-btn { padding: 1.1rem .5rem; font-size: .85rem; }
      .btn, .voice-btn { padding: 1rem; font-size: 1.05rem; }
      .tofrom-row { grid-template-columns: 1fr; }
      .dfes-meta6 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Incident Diary Pro</h1>
      <div id="incidentInfo" class="incident-info">Incident Logger - Set up your incident details</div>
    </header>

    <nav class="tab-nav" role="tablist">
      <button id="setup-btn" class="tab-btn active" role="tab" aria-selected="true" aria-controls="setup-tab">üìã Setup</button>
      <button id="notes-btn" class="tab-btn" role="tab" aria-selected="false" aria-controls="notes-tab" disabled>üìù Notes</button>
      <button id="report-btn" class="tab-btn" role="tab" aria-selected="false" aria-controls="report-tab" disabled>üìÑ Report</button>
    </nav>

    <main id="setup-tab" class="tab-content active" role="tabpanel" aria-labelledby="setup-btn">
      <form id="setupForm" class="setup-form">
        <div class="form-group">
          <label for="authorName">Author Name *</label>
          <input id="authorName" name="authorName" type="text" required placeholder="Enter your full name" autocomplete="name"/>
        </div>
        <div class="form-group">
          <label for="incidentName">Incident Name (optional)</label>
          <input id="incidentName" name="incidentName" type="text" placeholder="Bunbury Bushfire"/>
        </div>
        <div class="form-group">
          <label for="incidentNumber">Incident Number</label>
          <div class="incident-row">
            <input id="incidentNumber" name="incidentNumber" type="text" placeholder="e.g., 621223" autocomplete="off"/>
            <label class="no-incident-checkbox">
              <input type="checkbox" id="noIncidentCheckbox"/> No Incident Number
            </label>
          </div>
        </div>
        <div class="form-group">
          <label for="dfesId">DFES ID Number (Service No) *</label>
          <input id="dfesId" name="dfesId" type="text" required placeholder="e.g., 123456" autocomplete="off"/>
        </div>
        <div class="form-group">
          <label for="userRole">Your Role *</label>
          <input id="userRole" name="userRole" type="text" required placeholder="e.g., RDC, IC, OO, PO, PIO, LO"/>
        </div>
        <div class="form-group">
          <label for="diaryPageStart">Diary Page Number (optional)</label>
          <input id="diaryPageStart" name="diaryPageStart" type="number" min="0" step="1" placeholder="e.g., 100 for PAGE: 000100"/>
        </div>
        <button id="submitBtn" type="submit" class="btn">Start Logging Notes</button>
      </form>
      <div id="setupStatus" class="status-message" style="display:none;"></div>
    </main>

    <main id="notes-tab" class="tab-content" role="tabpanel" aria-labelledby="notes-btn">
      <div class="notes-controls" style="max-width:1100px; margin:0 auto;">
        <textarea id="noteInput" class="note-input" placeholder="Enter your note here..."></textarea>
        <div class="input-row">
          <button id="voiceBtn" class="voice-btn" type="button">üé§ Voice</button>
          <button id="addNoteBtn" class="btn" type="button">Add Note</button>
        </div>
        <div class="tofrom-panel" aria-label="To/From options">
          <div class="tofrom-row">
            <label for="fromName">From</label>
            <input id="fromName" type="text" placeholder="Role or name (optional)"/>
            <label for="toName">To</label>
            <input id="toName" type="text" placeholder="Role or name (optional)"/>
          </div>
          <div class="tofrom-checks">
            <label><input type="checkbox" id="includeFrom" checked/> Include From</label>
            <label><input type="checkbox" id="includeTo" /> Include To</label>
            <label><input type="checkbox" id="followUpCheckbox"/> Requires Follow Up</label>
          </div>
        </div>
        <div id="voiceStatus" class="status-message" style="display:none;"></div>
      </div>
      <div id="notesList" class="notes-list" role="region" aria-label="Notes list">
        <div class="status-message status-info">No notes yet. Add your first note above!</div>
      </div>
    </main>

    <main id="report-tab" class="tab-content" role="tabpanel" aria-labelledby="report-btn">
      <div class="report-controls">
        <div class="report-search">
          <input id="reportSearchInput" type="text" placeholder="Search report rows..."/>
          <button id="reportSearchClear" type="button">Clear</button>
        </div>
      </div>

      <div id="reportPreview" class="report-preview">
        <div class="status-message status-info">Complete setup and add notes to generate a report.</div>
      </div>
      <div style="display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center;">
        <button id="downloadPdfBtn" class="btn btn-secondary" disabled>üñ®Ô∏è Print to PDF</button>
        <button id="emailBtn" class="btn btn-secondary" disabled>üìß Email Report</button>
        <button id="clearDataBtn" class="btn btn-danger">üóëÔ∏è Clear All Data</button>
      </div>
    </main>
  </div>

  <script>
    // In-memory state
    let appState = {
      author: "",
      incidentName: "",
      incidentNumber: "",
      noIncident: false,
      dfesId: "",
      role: "",
      diaryPageStart: null,
      notes: [],
      currentTab: "setup",
      isRecording: false,
      recognition: null,
      voiceTranscript: ""
    };

    // Helpers
    function $(id){ return document.getElementById(id); }
    function show(el){ el.style.display = "block"; }
    function hide(el){ el.style.display = "none"; }
    function showStatus(id, message, type){
      var el = $(id); if(!el) return;
      el.textContent = message;
      el.className = "status-message status-" + (type || "info");
      show(el);
    }
    function hideStatus(id){ var el = $(id); if(el) hide(el); }
    function formatTimestamp(ts, withSeconds){
      var d = new Date(ts);
      var dd = String(d.getDate()).padStart(2,"0");
      var mm = String(d.getMonth()+1).padStart(2,"0");
      var yy = String(d.getFullYear()).slice(-2);
      var hh = String(d.getHours()).padStart(2,"0");
      var mi = String(d.getMinutes()).padStart(2,"0");
      var ss = String(d.getSeconds()).padStart(2,"0");
      return dd + "/" + mm + "/" + yy + " " + hh + ":" + mi + (withSeconds ? ":" + ss : "");
    }
    function escapeHtml(text){
      var div = document.createElement("div");
      div.textContent = text || "";
      return div.innerHTML;
    }
    function pad6(n){
      var num = Math.max(0, parseInt(n,10) || 0);
      return String(num).padStart(6,"0");
    }

    document.addEventListener("DOMContentLoaded", function(){
      setupEvents();
      setupSpeechRecognition();
    });

    function setupEvents(){
      $("setup-btn").addEventListener("click", function(){ switchTab("setup"); });
      $("notes-btn").addEventListener("click", function(){ switchTab("notes"); });
      $("report-btn").addEventListener("click", function(){ switchTab("report"); });

      $("setupForm").addEventListener("submit", onSetupSubmit);
      $("noIncidentCheckbox").addEventListener("change", function(e){
        appState.noIncident = e.target.checked;
        var incInput = $("incidentNumber");
        incInput.disabled = appState.noIncident;
        if (appState.noIncident) incInput.value = "";
      });

      $("addNoteBtn").addEventListener("click", addNote);
      $("noteInput").addEventListener("keydown", function(e){
        if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) { e.preventDefault(); addNote(); }
      });

      $("reportSearchInput").addEventListener("input", function(){
        $("reportSearchClear").style.display = $("reportSearchInput").value ? "inline-block" : "none";
        generateReport();
      });
      $("reportSearchClear").addEventListener("click", function(){
        $("reportSearchInput").value = "";
        $("reportSearchClear").style.display = "none";
        generateReport();
      });

      $("downloadPdfBtn").addEventListener("click", printToPdf);
      $("emailBtn").addEventListener("click", emailReport);
      $("clearDataBtn").addEventListener("click", clearAllData);

      $("notesList").addEventListener("click", notesListClick);
    }

    function onSetupSubmit(e){
      e.preventDefault();
      appState.author = $("authorName").value.trim();
      appState.incidentName = $("incidentName").value.trim();
      appState.incidentNumber = $("incidentNumber").value.trim();
      appState.noIncident = $("noIncidentCheckbox").checked;
      appState.dfesId = $("dfesId").value.trim();
      appState.role = $("userRole").value.trim();
      var pageVal = $("diaryPageStart").value.trim();
      appState.diaryPageStart = pageVal === "" ? null : Math.max(0, parseInt(pageVal,10) || 0);

      if (!(appState.author && appState.dfesId && appState.role && (appState.noIncident || appState.incidentNumber))) {
        showStatus("setupStatus", "Please fill all required fields.", "error");
        return;
      }
      updateIncidentInfo();
      $("notes-btn").disabled = false;
      $("report-btn").disabled = false;
      switchTab("notes");
      $("noteInput").focus();
      showStatus("setupStatus", "Setup complete!", "success");
      setTimeout(function(){ hideStatus("setupStatus"); }, 2500);
    }

    function updateIncidentInfo(){
      var incText = appState.noIncident ? "No Incident Number" : appState.incidentNumber;
      var incName = appState.incidentName ? " | " + appState.incidentName : "";
      var pagePreview = " | Page Start: " + pad6(appState.diaryPageStart != null ? appState.diaryPageStart : 1);
      $("incidentInfo").textContent = incText + incName + " | DFES ID: " + appState.dfesId + " | " + appState.author + " (" + appState.role + ")" + pagePreview;
    }

    function switchTab(tab){
      if (tab !== "setup" && ($("notes-btn").disabled || $("report-btn").disabled)) {
        showStatus("setupStatus", "Please complete setup first.", "error");
        return;
      }
      appState.currentTab = tab;
      document.querySelectorAll(".tab-btn").forEach(function(b){
        var isActive = b.id === (tab + "-btn");
        b.classList.toggle("active", isActive);
        b.setAttribute("aria-selected", isActive);
      });
      document.querySelectorAll(".tab-content").forEach(function(c){ c.classList.remove("active"); });
      $(tab + "-tab").classList.add("active");
      if (tab === "report") generateReport();
      if (tab === "notes") renderNotes();
    }

    function addNote(){
      var text = $("noteInput").value.trim();
      var follow = $("followUpCheckbox").checked;
      var toName = $("toName").value.trim();
      var fromName = $("fromName").value.trim();
      var includeTo = $("includeTo").checked && toName.length > 0;
      var includeFrom = $("includeFrom").checked && fromName.length > 0;

      if (!text) return;

      var note = {
        id: Date.now(),
        timestamp: new Date(),
        text: text,
        followUp: follow,
        followUpDetails: "",
        followUpTimestamp: null,
        to: toName,
        from: fromName,
        includeTo: includeTo,
        includeFrom: includeFrom
      };
      appState.notes.unshift(note);

      $("noteInput").value = "";
      $("followUpCheckbox").checked = false;

      renderNotes();
      showStatus("voiceStatus", "Note added.", "success");
      setTimeout(function(){ hideStatus("voiceStatus"); }, 2000);
    }

    function deleteNote(id){
      if (!confirm("Delete this note?")) return;
      appState.notes = appState.notes.filter(function(n){ return n.id !== id; });
      renderNotes();
    }

    function editNoteInline(id){
      var textEl = document.getElementById("note-text-" + id);
      var n = appState.notes.find(function(x){ return x.id === id; });
      if (!n || !textEl) return;
      var original = n.text;
      textEl.innerHTML =
        '<textarea id="edit-' + id + '" class="note-input" style="min-height:80px;">' + escapeHtml(original) + '</textarea>' +
        '<div class="input-row" style="margin-top:.5rem;">' +
          '<button class="btn" data-action="save-edit">Save</button>' +
          '<button class="btn btn-secondary" data-action="cancel-edit">Cancel</button>' +
        '</div>';
      document.getElementById("edit-" + id).focus();
    }

    function saveNoteEdit(id){
      var ta = document.getElementById("edit-" + id);
      if (!ta) return;
      var n = appState.notes.find(function(x){ return x.id === id; });
      if (!n) return;
      var newText = ta.value.trim();
      if (newText) n.text = newText;
      renderNotes();
    }

    function cancelNoteEdit(){ renderNotes(); }

    function completeFollowUp(id){
      var n = appState.notes.find(function(x){ return x.id === id; });
      if (!n) return;
      var ta = document.querySelector("#followup-input-" + id + " .note-followup-details");
      n.followUpDetails = (ta && ta.value ? ta.value : "").trim();
      n.followUpTimestamp = new Date();
      renderNotes();
      showStatus("voiceStatus", "Follow up recorded.", "success");
      setTimeout(function(){ hideStatus("voiceStatus"); }, 1500);
    }

    function notesListClick(e){
      var actionEl = e.target.closest("[data-action]");
      if (!actionEl) return;
      var noteItem = e.target.closest(".note-item");
      var id = parseInt((noteItem && noteItem.dataset.noteId) || "0", 10);
      var action = actionEl.getAttribute("data-action");
      if (action === "delete-note") deleteNote(id);
      else if (action === "edit-note") editNoteInline(id);
      else if (action === "save-edit") saveNoteEdit(id);
      else if (action === "cancel-edit") cancelNoteEdit();
      else if (action === "complete-followup") completeFollowUp(id);
    }

    function renderNotes(){
      var list = $("notesList");
      var notes = appState.notes;
      if (notes.length === 0) {
        list.innerHTML = '<div class="status-message status-info">No notes yet. Add your first note above!</div>';
        return;
      }
      list.innerHTML = notes.map(function(n){
        var t = formatTimestamp(n.timestamp);
        var toStr = n.includeTo ? " | To: " + escapeHtml(n.to) : "";
        var fromStr = n.includeFrom ? " | From: " + escapeHtml(n.from) : "";
        var fu = n.followUp ? " | Follow-up: Yes" : "";
        return (
          '<div class="note-item" data-note-id="' + n.id + '">' +
            '<div class="note-header">' +
              '<div class="note-timestamp">' + t + fromStr + toStr + fu + '</div>' +
              '<div class="note-actions">' +
                '<button class="note-action-btn" data-action="edit-note" title="Edit">‚úèÔ∏è</button>' +
                '<button class="note-action-btn" data-action="delete-note" title="Delete">üóëÔ∏è</button>' +
              '</div>' +
            '</div>' +
            '<div class="note-content">' +
              '<div id="note-text-' + n.id + '" class="note-text">' + escapeHtml(n.text) + '</div>' +
              (n.followUp && !n.followUpDetails
                ? '<div id="followup-input-' + n.id + '" style="margin-top:.5rem;">' +
                    '<textarea class="note-followup-details" placeholder="Enter follow up details..." style="width:100%; min-height:60px; padding:.5rem; border:1px solid #444; background:#1a1a1a; color:#fff; border-radius:6px;"></textarea>' +
                    '<div class="input-row" style="margin-top:.5rem;">' +
                      '<button class="btn btn-secondary" data-action="complete-followup" style="width:auto;">Complete Follow Up</button>' +
                    '</div>' +
                  '</div>'
                : ''
              ) +
              (n.followUpDetails
                ? '<div class="status-message status-info" style="margin-top:.5rem; text-align:left;">' +
                    '<strong>Follow-up @ ' + formatTimestamp(n.followUpTimestamp) + ':</strong><br>' + escapeHtml(n.followUpDetails) +
                  '</div>'
                : ''
              ) +
            '</div>' +
          '</div>'
        );
      }).join("");
    }

    // Report generation with condensed header (2 rows √ó 3 columns)
    function generateReport(){
      var prev = $("reportPreview");
      if (appState.notes.length === 0) {
        prev.innerHTML = '<div class="status-message status-info">Add notes to generate a report.</div>';
        toggleReportButtons(false);
        return;
      }

      var searchTerm = ($("reportSearchInput").value || "").toLowerCase().trim();
      var sourceNotes = appState.notes.slice().reverse().filter(function(n){
        if (!searchTerm) return true;
        return (
          (n.text || "").toLowerCase().includes(searchTerm) ||
          (n.followUpDetails || "").toLowerCase().includes(searchTerm) ||
          (n.includeFrom ? (n.from || "").toLowerCase().includes(searchTerm) : false) ||
          (n.includeTo ? (n.to || "").toLowerCase().includes(searchTerm) : false) ||
          formatTimestamp(n.timestamp).toLowerCase().includes(searchTerm)
        );
      });

      var incNumber = appState.noIncident ? "" : appState.incidentNumber;
      var incName = appState.incidentName || "";
      var dateStr = new Date().toLocaleDateString("en-GB");
      var dfesId = appState.dfesId;
      var author = appState.author;
      var role = appState.role;

      var rowsPerPage = 22;
      var pages = [];
      for (var i = 0; i < sourceNotes.length; i += rowsPerPage) {
        pages.push(sourceNotes.slice(i, i + rowsPerPage));
      }
      var startPage = appState.diaryPageStart != null ? appState.diaryPageStart : 1;

      var pagesHtml = pages.map(function(notesChunk, pageIndex){
        var pageNumberPadded = pad6(startPage + pageIndex);
        var rowsHtml = notesChunk.map(function(n){
          var datetime = formatTimestamp(n.timestamp);
          var from = n.includeFrom ? escapeHtml(n.from) : "";
          var to = n.includeTo ? escapeHtml(n.to) : "";
          var noteText = escapeHtml(n.text);
          var fu = n.followUp ? " (Follow-up required)" : "";
          var fuDet = n.followUpDetails ? "<br>Follow-up @ " + escapeHtml(formatTimestamp(n.followUpTimestamp)) + ": " + escapeHtml(n.followUpDetails) : "";
          return (
            "<tr>" +
              '<td class="col-datetime">' + datetime + "</td>" +
              '<td class="col-from">' + from + "</td>" +
              '<td class="col-to">' + to + "</td>" +
              '<td class="col-note">' + noteText + fu + fuDet + "</td>" +
            "</tr>"
          );
        }).join("");

        return (
          '<section class="dfes-sheet" style="' + (pageIndex < pages.length - 1 ? "page-break-after: always;" : "") + '">' +
            '<div class="dfes-title">PERSONAL INCIDENT DIARY</div>' +
            '<div class="dfes-page-row">' +
              "<div></div>" +
              '<div class="dfes-page">PAGE: <span class="num">' + pageNumberPadded + "</span></div>" +
            "</div>" +
            '<div class="dfes-meta6">' +
              '<div class="field"><div class="label">INCIDENT NAME:</div><div class="value">' + (incName || "&nbsp;") + "</div></div>" +
              '<div class="field"><div class="label">INCIDENT No.:</div><div class="value">' + (incNumber || "&nbsp;") + "</div></div>" +
              '<div class="field"><div class="label">DATE:</div><div class="value">' + dateStr + "</div></div>" +
              '<div class="field"><div class="label">NAME:</div><div class="value">' + escapeHtml(author) + "</div></div>" +
              '<div class="field"><div class="label">ROLE:</div><div class="value">' + escapeHtml(role) + "</div></div>" +
              '<div class="field"><div class="label">SERVICE No:</div><div class="value">' + escapeHtml(dfesId) + "</div></div>" +
            "</div>" +
            '<table class="dfes-grid" role="table" aria-label="Incident diary grid">' +
              "<thead>" +
                "<tr>" +
                  '<th class="col-datetime">DATE & TIME</th>' +
                  '<th class="col-from">FROM</th>' +
                  '<th class="col-to">TO</th>' +
                  '<th class="col-note">NOTE</th>' +
                "</tr>" +
              "</thead>" +
              "<tbody>" +
                (rowsHtml || '<tr><td colspan="4" style="text-align:center; color:#666;">No entries</td></tr>') +
              "</tbody>" +
            "</table>" +
          "</section>"
        );
      }).join("");

      $("reportPreview").innerHTML = pagesHtml || '<div class="status-message status-info">No rows after filtering.</div>';
      toggleReportButtons(true);
    }

    function toggleReportButtons(enabled){
      ["downloadPdfBtn", "emailBtn"].forEach(function(id){
        var b = $(id); if (b) b.disabled = !enabled;
      });
    }

    function printToPdf(){
      var w = window.open("", "_blank");
      var html =
        "<!DOCTYPE html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1.0'>" +
        "<style>" + document.querySelector("style").innerHTML + "</style>" +
        "<title>Incident Diary Report</title></head><body>" +
        $("reportPreview").innerHTML +
        "</body></html>";
      w.document.write(html);
      w.document.close();
      w.onload = function(){ w.print(); w.close(); };
    }

    function emailReport(){
      var subject = encodeURIComponent("Incident Report" + (appState.incidentNumber ? " - " + appState.incidentNumber : ""));
      var body = encodeURIComponent(generateEmailBody());
      window.location.href = "mailto:?subject=" + subject + "&body=" + body;
    }

    function generateEmailBody(){
      var lines = [];
      var dateStr = new Date().toLocaleDateString("en-GB");
      lines.push("PERSONAL INCIDENT DIARY (Landscape)");
      lines.push("Incident Name: " + (appState.incidentName || ""));
      lines.push("Incident No: " + (appState.noIncident ? "N/A" : appState.incidentNumber));
      lines.push("Date: " + dateStr);
      lines.push("Name: " + appState.author);
      lines.push("Role: " + appState.role);
      lines.push("Service No: " + appState.dfesId);
      lines.push("Start Page: " + pad6(appState.diaryPageStart != null ? appState.diaryPageStart : 1));
      lines.push("");
      appState.notes.slice().reverse().forEach(function(n){
        lines.push("Date & Time: " + formatTimestamp(n.timestamp) + " | From: " + (n.includeFrom ? n.from : "") + " | To: " + (n.includeTo ? n.to : ""));
        lines.push(n.text);
        if (n.followUp) lines.push("Follow-up required.");
        if (n.followUpDetails) lines.push("Follow-up @ " + formatTimestamp(n.followUpTimestamp) + ": " + n.followUpDetails);
        lines.push("");
      });
      return lines.join("\n");
    }

    function clearAllData(){
      if (!confirm("Clear all data?")) return;
      appState = {
        author:"", incidentName:"", incidentNumber:"", noIncident:false, dfesId:"", role:"",
        diaryPageStart: null, notes:[], currentTab:"setup", isRecording:false, recognition: appState.recognition, voiceTranscript:""
      };
      $("setupForm").reset();
      $("noteInput").value = "";
      $("followUpCheckbox").checked = false;
      $("includeFrom").checked = true;
      $("includeTo").checked = false;
      $("fromName").value = "";
      $("toName").value = "";
      $("incidentInfo").textContent = "Incident Logger - Set up your incident details";
      $("notes-btn").disabled = true;
      $("report-btn").disabled = true;
      switchTab("setup");
      renderNotes();
      generateReport();
      showStatus("voiceStatus", "All data cleared.", "success");
      setTimeout(function(){ hideStatus("voiceStatus"); }, 1500);
    }

    function setupSpeechRecognition(){
      if (!("webkitSpeechRecognition" in window) && !("SpeechRecognition" in window)) {
        var vb = $("voiceBtn"); vb.disabled = true; vb.textContent = "üé§ Not Supported"; vb.title = "Speech recognition not supported"; return;
      }
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      appState.recognition = new SR();
      appState.recognition.continuous = true;
      appState.recognition.interimResults = true;
      appState.recognition.lang = "en-US";

      $("voiceBtn").addEventListener("click", function(){
        if (appState.isRecording) { appState.recognition.stop(); return; }
        try { appState.recognition.start(); } catch (e) {}
      });

      appState.recognition.onstart = function(){
        appState.isRecording = true;
        appState.voiceTranscript = "";
        $("voiceBtn").classList.add("recording");
        $("voiceBtn").textContent = "üî¥ Recording...";
        showStatus("voiceStatus", "Listening... Speak now", "info");
      };
      appState.recognition.onresult = function(ev){
        var interim = "";
        for (var i = ev.resultIndex; i < ev.results.length; i++) {
          var t = ev.results[i][0].transcript;
          if (ev.results[i].isFinal) appState.voiceTranscript += t + " ";
          else interim += t;
        }
        if (interim) showStatus("voiceStatus", "Interim: " + interim, "info");
      };
      appState.recognition.onerror = function(e){
        showStatus("voiceStatus", "Voice error: " + e.error, "error");
        stopVoice();
      };
      appState.recognition.onend = function(){
        if (appState.voiceTranscript.trim()) $("noteInput").value = appState.voiceTranscript.trim();
        stopVoice();
        showStatus("voiceStatus", "Transcript ready. Edit if needed, then Add Note.", "success");
        setTimeout(function(){ hideStatus("voiceStatus"); }, 2500);
      };

      function stopVoice(){
        appState.isRecording = false;
        $("voiceBtn").classList.remove("recording");
        $("voiceBtn").textContent = "üé§ Voice";
      }
    }
  </script>
</body>
</html>
